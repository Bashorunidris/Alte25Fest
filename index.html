<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pose Music Library</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
        }

        .header {
            background: rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid rgba(100, 200, 255, 0.3);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ff0050;
        }

        .user-section {
            display: none;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            color: #fff;
        }

        .user-email {
            font-size: 12px;
            color: #aaa;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff0050, #ff4081);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 0, 80, 0.3);
        }

        .btn-secondary {
            background: rgba(100, 200, 255, 0.2);
            color: #64c8ff;
            border: 1px solid rgba(100, 200, 255, 0.5);
        }

        .btn-secondary:hover {
            background: rgba(100, 200, 255, 0.3);
        }

        .btn-danger {
            background: rgba(255, 100, 100, 0.2);
            color: #ff6464;
            border: 1px solid rgba(255, 100, 100, 0.5);
        }

        .btn-danger:hover {
            background: rgba(255, 100, 100, 0.4);
        }

        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-card {
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid rgba(100, 200, 255, 0.3);
            border-radius: 12px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .auth-card h2 {
            margin-bottom: 30px;
            font-size: 28px;
            text-align: center;
            color: #ff0050;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #aaa;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(100, 200, 255, 0.3);
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(100, 200, 255, 0.8);
        }

        .toggle-auth {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #aaa;
        }

        .toggle-auth a {
            color: #ff0050;
            cursor: pointer;
            text-decoration: underline;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
            display: none;
        }

        .container.active {
            display: block;
        }

        .section-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 30px;
        }

        .add-song-card {
            background: rgba(26, 26, 46, 0.8);
            border: 1px solid rgba(100, 200, 255, 0.3);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            background: rgba(100, 200, 255, 0.1);
            border: 2px dashed rgba(100, 200, 255, 0.5);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .file-input-label:hover {
            background: rgba(100, 200, 255, 0.2);
            border-color: rgba(100, 200, 255, 0.8);
        }

        .file-input-label input {
            display: none;
        }

        .file-name {
            font-size: 12px;
            color: #aaa;
            margin-top: 5px;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: auto auto;
            gap: 20px;
            margin-bottom: 20px;
        }

        .image-preview {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(100, 200, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            font-size: 40px;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0050, #ff4081);
            width: 0%;
            transition: width 0.3s ease;
        }

        .songs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .song-card {
            background: rgba(26, 26, 46, 0.8);
            border: 1px solid rgba(100, 200, 255, 0.3);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .song-card:hover {
            border-color: rgba(100, 200, 255, 0.8);
            transform: translateY(-2px);
        }

        .song-cover {
            width: 100%;
            height: 200px;
            background: rgba(100, 200, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            overflow: hidden;
        }

        .song-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .song-content {
            padding: 20px;
        }

        .song-title {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }

        .song-artist {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 15px;
        }

        .song-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            padding: 15px 0;
            border-top: 1px solid rgba(100, 200, 255, 0.2);
            border-bottom: 1px solid rgba(100, 200, 255, 0.2);
            margin-bottom: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #64c8ff;
        }

        .stat-label {
            font-size: 11px;
            color: #aaa;
        }

        .song-actions {
            display: flex;
            gap: 10px;
        }

        .song-actions button {
            flex: 1;
            padding: 8px;
            font-size: 12px;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(100, 200, 255, 0.5);
            color: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 2000;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #aaa;
        }

        .empty-state-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .songs-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <i class="fas fa-music"></i> Pose Music Library
        </div>
        <div class="user-section" id="userSection">
            <div class="user-info">
                <div class="user-name" id="userName">User</div>
                <div class="user-email" id="userEmail">user@example.com</div>
            </div>
            <button class="btn btn-danger" onclick="signOut()">Sign Out</button>
        </div>
        <div id="authButtons" style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="toggleAuth('signin')">Sign In</button>
            <button class="btn btn-primary" onclick="toggleAuth('signup')">Sign Up</button>
        </div>
    </div>

    <!-- Auth Section -->
    <div id="authSection" class="auth-container">
        <!-- Sign In Form -->
        <div id="signInForm" class="auth-card">
            <h2>Sign In</h2>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="signInEmail" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="signInPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="handleSignIn()">Sign In</button>
            <div class="toggle-auth">
                Don't have an account? <a onclick="toggleAuth('signup')">Sign Up</a>
            </div>
        </div>

        <!-- Sign Up Form -->
        <div id="signUpForm" class="auth-card" style="display: none;">
            <h2>Sign Up</h2>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="signUpName" placeholder="Your name">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="signUpEmail" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="signUpPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="handleSignUp()">Sign Up</button>
            <div class="toggle-auth">
                Already have an account? <a onclick="toggleAuth('signin')">Sign In</a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container" id="mainContent">
        <!-- Add Song Section -->
        <div class="add-song-card">
            <h3><i class="fas fa-plus-circle"></i> Add New Song</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Song Title</label>
                    <input type="text" id="songTitle" placeholder="Enter song title">
                </div>
                <div class="form-group">
                    <label>Artist Name</label>
                    <input type="text" id="artistName" placeholder="Enter artist name">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Country</label>
                    <select id="songCountry" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(100, 200, 255, 0.3); border-radius: 6px; color: #fff; font-size: 14px;">
                        <option value="">Select Country</option>
                        <option value="Nigeria">Nigeria</option>
                        <option value="Ghana">Ghana</option>
                        <option value="South Africa">South Africa</option>
                        <option value="Kenya">Kenya</option>
                        <option value="Uganda">Uganda</option>
                        <option value="USA">USA</option>
                        <option value="UK">UK</option>
                        <option value="Canada">Canada</option>
                        <option value="France">France</option>
                        <option value="Germany">Germany</option>
                        <option value="Jamaica">Jamaica</option>
                        <option value="Brazil">Brazil</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Genre</label>
                    <select id="songGenre" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(100, 200, 255, 0.3); border-radius: 6px; color: #fff; font-size: 14px;">
                        <option value="">Select Genre</option>
                        <option value="Afrobeat">Afrobeat</option>
                        <option value="Amapiano">Amapiano</option>
                        <option value="Trap">Trap</option>
                        <option value="Drill">Drill</option>
                        <option value="Dancehall">Dancehall</option>
                        <option value="Hip-Hop">Hip-Hop</option>
                        <option value="Pop">Pop</option>
                        <option value="R&B">R&B</option>
                        <option value="Rock">Rock</option>
                        <option value="Electronic">Electronic</option>
                        <option value="Jazz">Jazz</option>
                        <option value="Reggae">Reggae</option>
                        <option value="Grime">Grime</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>

            <div class="form-row full">
                <label class="file-input-label" for="imageFile">
                    <i class="fas fa-image"></i>
                    <span>Click to upload song cover image</span>
                </label>
                <input type="file" id="imageFile" accept="image/*">
                <div class="file-name" id="imageName"></div>
            </div>

            <div class="form-row full">
                <label class="file-input-label" for="audioFile">
                    <i class="fas fa-music"></i>
                    <span>Click to upload audio file (MP3, WAV, OGG)</span>
                </label>
                <input type="file" id="audioFile" accept="audio/*">
                <div class="file-name" id="audioName"></div>
            </div>

            <div class="preview-grid">
                <div>
                    <label>Image</label>
                    <div class="image-preview" id="imagePreview">
                        <i class="fas fa-image"></i>
                    </div>
                </div>
            </div>

            <div id="uploadProgress" style="display: none; margin-top: 20px;">
                <div>Uploading: <span id="uploadStatus">0%</span></div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="uploadSong()">
                <i class="fas fa-cloud-upload-alt"></i> Upload Song
            </button>
        </div>

        <!-- Songs Library -->
        <div>
            <h2 class="section-title">
                <i class="fas fa-music"></i> Your Songs
            </h2>
            <div class="songs-grid" id="songsGrid">
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸŽµ</div>
                    <div>No songs yet. Upload your first song!</div>
                </div>
            </div>
        </div>
    </div>
 <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- html2canvas for capturing edited photos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        console.log('Script loaded!');

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDW8V2SjNITrA4LcdmeILh944mTbOKnM0c",
            authDomain: "rewarderhub.firebaseapp.com",
            projectId: "rewarderhub",
            storageBucket: "rewarderhub.appspot.com",
            messagingSenderId: "85965945106",
            appId: "1:85965945106:web:fa0a57d8968926e1041bcb",
            measurementId: "G-F2ERB5NGN0"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
      const storage = firebase.storage();

        // Cloudinary Config
        const CLOUDINARY_CLOUD_NAME = 'dzhdgxjhl';
        const CLOUDINARY_UPLOAD_PRESET = 'posepreset';
        const CLOUDINARY_API_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`;

        // State
        let currentUser = null;
        let selectedImage = null;
        let selectedAudio = null;

        // Check Auth State
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            if (user) {
                showMainApp();
                document.getElementById('userName').textContent = user.displayName || 'User';
                document.getElementById('userEmail').textContent = user.email;
                loadUserSongs();
            } else {
                showAuthScreen();
            }
        });

        function showMainApp() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('mainContent').classList.add('active');
            document.getElementById('userSection').style.display = 'flex';
            document.getElementById('authButtons').style.display = 'none';
        }

        function showAuthScreen() {
            document.getElementById('authSection').style.display = 'flex';
            document.getElementById('mainContent').classList.remove('active');
            document.getElementById('userSection').style.display = 'none';
            document.getElementById('authButtons').style.display = 'flex';
        }

        function toggleAuth(type) {
            if (type === 'signin') {
                document.getElementById('signInForm').style.display = 'block';
                document.getElementById('signUpForm').style.display = 'none';
            } else {
                document.getElementById('signInForm').style.display = 'none';
                document.getElementById('signUpForm').style.display = 'block';
            }
        }

        async function handleSignIn() {
            const email = document.getElementById('signInEmail').value.trim();
            const password = document.getElementById('signInPassword').value;

            if (!email || !password) {
                showToast('Enter email and password', 'error');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                showToast('âœ“ Signed in', 'success');
                document.getElementById('signInEmail').value = '';
                document.getElementById('signInPassword').value = '';
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        }

        async function handleSignUp() {
            const name = document.getElementById('signUpName').value.trim();
            const email = document.getElementById('signUpEmail').value.trim();
            const password = document.getElementById('signUpPassword').value;
            const confirmPassword = document.getElementById('signUpConfirmPassword').value;

            if (!name || !email || !password) {
                showToast('Fill all fields', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }

            if (password.length < 6) {
                showToast('Password must be 6+ characters', 'error');
                return;
            }

            try {
                const result = await auth.createUserWithEmailAndPassword(email, password);
                await result.user.updateProfile({ displayName: name });
                showToast('âœ“ Account created', 'success');
                clearAuthForms();
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        }

        function signOut() {
            auth.signOut().then(() => {
                showToast('Signed out', 'success');
                clearAuthForms();
            });
        }

        function clearAuthForms() {
            document.getElementById('signInEmail').value = '';
            document.getElementById('signInPassword').value = '';
            document.getElementById('signUpName').value = '';
            document.getElementById('signUpEmail').value = '';
            document.getElementById('signUpPassword').value = '';
            document.getElementById('signUpConfirmPassword').value = '';
        }

        // File Handlers
        document.getElementById('imageFile').addEventListener('change', function() {
            selectedImage = this.files[0];
            if (selectedImage) {
                document.getElementById('imageName').textContent = selectedImage.name;
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('imagePreview').innerHTML = `<img src="${e.target.result}" alt="preview">`;
                };
                reader.readAsDataURL(selectedImage);
            }
        });

        document.getElementById('audioFile').addEventListener('change', function() {
            selectedAudio = this.files[0];
            if (selectedAudio) {
                document.getElementById('audioName').textContent = selectedAudio.name;
            }
        });

        // Upload to Cloudinary
        async function uploadToCloudinary(file, resourceType) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

                const xhr = new XMLHttpRequest();

                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = (e.loaded / e.total) * 100;
                        document.getElementById('progressFill').style.width = percent + '%';
                        document.getElementById('uploadStatus').textContent = Math.round(percent) + '%';
                    }
                });

                xhr.addEventListener('load', () => {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        
                        if (xhr.status === 200) {
                            resolve(data.secure_url);
                        } else {
                            reject(new Error(data.error?.message || `Upload failed: ${xhr.status}`));
                        }
                    } catch (e) {
                        reject(new Error(`Invalid response: ${xhr.responseText}`));
                    }
                });

                xhr.addEventListener('error', () => reject(new Error('Network error - check CORS or upload preset')));

                const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${resourceType}/upload`;
                xhr.open('POST', url);
                xhr.send(formData);
            });
        }

        // Upload Song
        async function uploadSong() {
            const title = document.getElementById('songTitle').value.trim();
            const artist = document.getElementById('artistName').value.trim();
            const country = document.getElementById('songCountry').value.trim();
            const genre = document.getElementById('songGenre').value.trim();

            if (!title || !artist) {
                showToast('Enter title and artist', 'error');
                return;
            }

            if (!country || !genre) {
                showToast('Select country and genre', 'error');
                return;
            }

            if (!selectedImage || !selectedAudio) {
                showToast('Select image and audio', 'error');
                return;
            }

            if (!currentUser) {
                showToast('Sign in first', 'error');
                return;
            }

            try {
                document.getElementById('uploadProgress').style.display = 'block';

                const imageUrl = await uploadToCloudinary(selectedImage, 'image');
                const audioUrl = await uploadToCloudinary(selectedAudio, 'video');

                // Get today's date in YYYY-MM-DD format
                const today = new Date().toISOString().split('T')[0];
                
                // Create song object
                const newSong = {
                    id: Date.now().toString(),
                    title: title,
                    artist: artist,
                    country: country,
                    genre: genre,
                    imageUrl: imageUrl,
                    audioUrl: audioUrl,
                    uploadedAt: new Date(),
                    plays: 0,
                    likes: 0,
                    downloads: 0
                };

                // Save to songs_by_date collection (one document per day)
                const dateDocRef = db.collection('users').doc(currentUser.uid).collection('songs_by_date').doc(today);
                const dateDoc = await dateDocRef.get();
                
                if (dateDoc.exists) {
                    // Add to existing array
                    await dateDocRef.update({
                        songs: firebase.firestore.FieldValue.arrayUnion(newSong),
                        lastUpdated: new Date()
                    });
                } else {
                    // Create new document with first song
                    await dateDocRef.set({
                        date: today,
                        songs: [newSong],
                        createdAt: new Date(),
                        lastUpdated: new Date()
                    });
                }

                showToast('âœ“ Song uploaded', 'success');

                document.getElementById('songTitle').value = '';
                document.getElementById('artistName').value = '';
                document.getElementById('songCountry').value = '';
                document.getElementById('songGenre').value = '';
                document.getElementById('imageFile').value = '';
                document.getElementById('audioFile').value = '';
                selectedImage = null;
                selectedAudio = null;
                document.getElementById('imagePreview').innerHTML = '<i class="fas fa-image"></i>';
                document.getElementById('imageName').textContent = '';
                document.getElementById('audioName').textContent = '';
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('progressFill').style.width = '0%';

                loadUserSongs();
            } catch (error) {
                console.error('Upload error:', error);
                showToast('Error: ' + error.message, 'error');
                document.getElementById('uploadProgress').style.display = 'none';
            }
        }

        // Load Songs
        async function loadUserSongs() {
            if (!currentUser) return;

            try {
                const grid = document.getElementById('songsGrid');
                grid.innerHTML = '';

                const allSongs = [];

                // Load from NEW structure (songs_by_date)
                const newSnapshot = await db.collection('users').doc(currentUser.uid).collection('songs_by_date').orderBy('date', 'desc').get();
                
                newSnapshot.forEach(dateDoc => {
                    const dateData = dateDoc.data();
                    if (dateData.songs && Array.isArray(dateData.songs)) {
                        allSongs.push(...dateData.songs.map(song => ({
                            ...song,
                            dateId: dateDoc.id
                        })));
                    }
                });

                // Load from OLD structure (songs) for backwards compatibility
                const oldSnapshot = await db.collection('users').doc(currentUser.uid).collection('songs').get();
                
                oldSnapshot.forEach(doc => {
                    const song = doc.data();
                    allSongs.push({
                        ...song,
                        id: song.id || doc.id,
                        dateId: 'legacy_' + doc.id,
                        isLegacy: true
                    });
                });

                if (allSongs.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸŽµ</div>
                            <div>No songs yet. Upload your first song!</div>
                        </div>
                    `;
                    return;
                }

                // Sort songs by uploadedAt (newest first)
                allSongs.sort((a, b) => (b.uploadedAt?.toDate?.() || new Date(0)) - (a.uploadedAt?.toDate?.() || new Date(0)));

                allSongs.forEach(song => {
                    const card = document.createElement('div');
                    card.className = 'song-card';
                    card.innerHTML = `
                        <div class="song-cover">
                            ${song.imageUrl ? `<img src="${song.imageUrl}" alt="${song.title}">` : '<i class="fas fa-music"></i>'}
                        </div>
                        <div class="song-content">
                            <div class="song-title">${song.title}</div>
                            <div class="song-artist">${song.artist}</div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 10px;">${song.country || 'Unknown'} â€¢ ${song.genre || 'Unknown'}</div>

                            <div class="song-stats">
                                <div>
                                    <div class="stat-value" onclick="updateStat('${song.dateId}', '${song.id}', 'plays')" style="cursor: pointer; transition: color 0.2s;">${song.plays || 0}</div>
                                    <div class="stat-label">Plays</div>
                                </div>
                                <div>
                                    <div class="stat-value" onclick="updateStat('${song.dateId}', '${song.id}', 'likes')" style="cursor: pointer; transition: color 0.2s;">${song.likes || 0}</div>
                                    <div class="stat-label">Likes</div>
                                </div>
                                <div>
                                    <div class="stat-value" onclick="updateStat('${song.dateId}', '${song.id}', 'downloads')" style="cursor: pointer; transition: color 0.2s;">${song.downloads || 0}</div>
                                    <div class="stat-label">Downloads</div>
                                </div>
                            </div>

                            <div class="song-actions">
                                <button class="btn btn-secondary" onclick="playSong('${song.audioUrl}')">
                                    <i class="fas fa-play"></i> Play
                                </button>
                                <button class="btn btn-danger" onclick="deleteSong('${song.dateId}', '${song.id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading songs:', error);
                showToast('Error loading songs', 'error');
            }
        }

        function playSong(audioUrl) {
            const audio = new Audio(audioUrl);
            audio.play().catch(error => {
                showToast('Error playing audio', 'error');
            });
        }

        async function updateStat(dateId, songId, statType) {
            try {
                const dateDocRef = db.collection('users').doc(currentUser.uid).collection('songs_by_date').doc(dateId);
                const dateDoc = await dateDocRef.get();
                
                if (dateDoc.exists) {
                    const songs = dateDoc.data().songs || [];
                    const songIndex = songs.findIndex(s => s.id === songId);
                    
                    if (songIndex !== -1) {
                        songs[songIndex][statType] = (songs[songIndex][statType] || 0) + 1;
                        await dateDocRef.update({
                            songs: songs,
                            lastUpdated: new Date()
                        });
                        loadUserSongs();
                    }
                }
            } catch (error) {
                console.error('Error updating stat:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }

        async function deleteSong(dateId, songId) {
            if (!confirm('Delete this song?')) return;

            try {
                // Check if it's a legacy song (old structure)
                if (dateId.startsWith('legacy_')) {
                    const legacyId = dateId.replace('legacy_', '');
                    await db.collection('users').doc(currentUser.uid).collection('songs').doc(legacyId).delete();
                } else {
                    // New structure
                    const dateDocRef = db.collection('users').doc(currentUser.uid).collection('songs_by_date').doc(dateId);
                    const dateDoc = await dateDocRef.get();
                    
                    if (dateDoc.exists) {
                        let songs = dateDoc.data().songs || [];
                        songs = songs.filter(s => s.id !== songId);
                        
                        if (songs.length === 0) {
                            // Delete the day document if no songs left
                            await dateDocRef.delete();
                        } else {
                            // Update with remaining songs
                            await dateDocRef.update({
                                songs: songs,
                                lastUpdated: new Date()
                            });
                        }
                    }
                }
                
                showToast('âœ“ Song deleted', 'success');
                loadUserSongs();
            } catch (error) {
                console.error('Error deleting song:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Initial
        document.getElementById('signInForm').style.display = 'block';
    </script>
</body>
</html>
